<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>관리자 페이지</title>
<style>

.dragging {
  opacity: 0.5;
  background: #e0f7ff;
}

.btn-row {
  display:flex;
  gap:8px;
  margin-bottom:10px;
}

.mini-btn {
  padding:4px 8px;
  font-size:12px;
  width:auto;
  cursor:pointer;
}

body {
  font-family:Arial;
  padding:20px;
  background:#f5f5f5;
}

/* 전체 컨테이너 */
.container {
  max-width:1000px;   /* 브라우저 커져도 이 이상 안 늘어남 */
  margin:0 auto;
}

/* 로그인 박스 */
.login {
  max-width:300px;
  margin:60px auto;
}

/* 입력 & 버튼 사이즈 축소 */
input {
  width:100%;
  padding:6px;
  margin-bottom:8px;
  font-size:13px;
}

button {
  padding:8px;
  width:100%;
  font-size:13px;
}

/* 광고 그리드 */
.grid {
  display:grid;
  grid-template-columns:repeat(6, 1fr);
  gap:8px;
}

/* 구분선 */
hr {
  margin:25px 0;
}

.hidden {
  display:none;
}
hr { margin:30px 0; }

/* 로그인 입력 공통 */
.login input {
  width:100%;
  padding:10px;
  margin-bottom:10px;
  box-sizing:border-box;
}

/* 비밀번호 입력란 와인색 테두리 */
#loginPw {
  border:2px solid #722f37; /* 와인색 */
}

/* 로그인 버튼 와인색 */
.login-btn {
  background:#722f37;
  color:#fff;
  border:none;
  padding:12px;
  width:100%;
  cursor:pointer;
}

.login-btn:hover {
  background:#5a232a;
}

/* 비밀번호 변경 영역 */
.pw-box {
  width:50%;
  margin:0 auto;
}

/* 입력란 + 버튼 완전 동일 사이즈 */
.pw-box input,
.pw-box button {
  width:100%;
  height:36px;        /* ← 입력창과 버튼 높이 동일 */
  padding:6px;
  font-size:13px;
  box-sizing:border-box;
}

/* 버튼 스타일만 색상 적용 */
.pw-box button {
  background:#722f37;   /* 와인색 */
  color:#fff;
  border:none;
  cursor:pointer;
}

.pw-box button:hover {
  background:#5a232a;
}

/* 저장 버튼 스타일 */
.save-btn {
  width:20%;          /* 20%로 축소 */
  margin:20px auto;   /* 가운데 정렬 */
  display:block;
  padding:10px;
  font-size:12px;
}
</style>
</head>
<body>

<div class="login" id="loginBox">
  <h3>관리자 로그인</h3>
  <input type="text" id="loginId" placeholder="아이디">
  <input type="password" id="loginPw" placeholder="비밀번호">
  <button class="login-btn" onclick="login()">로그인</button>
</div>

<div id="adminBox" class="hidden">
  <div class="container">

<h2>상단 배너 관리</h2>
<input id="bannerImg" placeholder="배너 이미지 URL">
<input id="bannerLink" placeholder="배너 클릭 링크">
<hr>

<h2>이미지 광고 관리</h2>

<div class="btn-row">
  <button type="button" class="mini-btn" onclick="addImageAd()">광고 추가 +</button>
  <button type="button" class="mini-btn" onclick="removeImageAd()">광고 삭제 −</button>
</div>

<div class="grid" id="imageAdmin"></div>

<h2 style="margin-top:30px;">텍스트 광고 관리</h2>

<div class="btn-row">
  <button type="button" class="mini-btn" onclick="addTextAd()">광고 추가 +</button>
  <button type="button" class="mini-btn" onclick="removeTextAd()">광고 삭제 −</button>
</div>

<div class="grid" id="textAdmin"></div>

<button class="save-btn" onclick="save()">저장</button>

<h3>사이트 소유자 설정</h3>
<input id="ownerName" placeholder="사이트 소유자 이름 입력">

    <hr>

    <!-- 비밀번호 변경 맨 아래 -->
<div class="pw-box">
  <h3>비밀번호 변경</h3>
  <input type="password" id="oldPw" placeholder="기존 비밀번호">
  <input type="password" id="newPw" placeholder="새 비밀번호">
  <button onclick="changePassword()">비밀번호 변경</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>

async function login() {

  const email = document.getElementById("loginId").value;
  const password = document.getElementById("loginPw").value;

  const { data, error } =
    await supabaseClient.auth.signInWithPassword({
      email: email,
      password: password
    });

  if (error) {
    alert("로그인 실패");
    console.log(error);
    return;
  }

  loginBox.style.display = "none";
  adminBox.style.display = "block";

  loadData();
}


supabaseClient.auth.getSession().then(({ data }) => {
  if (data.session) {
    loginBox.style.display = "none";
    adminBox.style.display = "block";
    loadData();
  }
});

async function loadData() {

  imageAdmin.innerHTML = "";
  textAdmin.innerHTML = "";

  const { data: ads } = await supabaseClient
    .from("ads")
    .select("*")
    .order("id", { ascending: true });

  if (ads && ads.length > 0) {

    ads.forEach(ad => {

      if (ad.type === "image") {
        addImageAd(ad.image_url || "", ad.link_url || "");
      }

      if (ad.type === "text") {
        addTextAd(ad.title || "", ad.link_url || "");
      }

    });

  }

  // 사이트 설정
  const { data: settings } = await supabaseClient
    .from("site_settings")
    .select("*")
    .limit(1);

  if (settings && settings.length > 0) {
    bannerImg.value = settings[0].banner_img || "";
    bannerLink.value = settings[0].banner_link || "";
    ownerName.value = settings[0].owner_name || "";
  }
}

async function save() {

  const { data: { session } } =
    await supabaseClient.auth.getSession();

  if (!session) {
    alert("로그인이 필요합니다");
    return;
  }

  // 1️⃣ 기존 광고 전체 삭제
  await supabaseClient
    .from("ads")
    .delete()
    .neq("id", 0);

  // 2️⃣ 이미지 광고 현재 화면 순서대로 저장
  const imgBlocks = imageAdmin.children;

  for (let block of imgBlocks) {

    const inputs = block.querySelectorAll("input");

    const img = inputs[0].value.trim();
    const link = inputs[1].value.trim();

    if (img !== "") {
      await supabaseClient.from("ads").insert([{
        type: "image",
        title: "",
        image_url: img,
        link_url: link
      }]);
    }
  }

  // 3️⃣ 텍스트 광고 현재 화면 순서대로 저장
  const txtBlocks = textAdmin.children;

  for (let block of txtBlocks) {

    const inputs = block.querySelectorAll("input");

    const text = inputs[0].value.trim();
    const link = inputs[1].value.trim();

    if (text !== "") {
      await supabaseClient.from("ads").insert([{
        type: "text",
        title: text,
        image_url: "",
        link_url: link
      }]);
    }
  }

  // 4️⃣ 사이트 설정 저장
  await supabaseClient
    .from("site_settings")
    .delete()
    .neq("id", 0);

  await supabaseClient
    .from("site_settings")
    .insert([{
      banner_img: bannerImg.value.trim(),
      banner_link: bannerLink.value.trim(),
      owner_name: ownerName.value.trim()
    }]);

  alert("저장 완료");
}

// 이미지 광고 입력칸 추가
function addImageAd(img = "", link = "") {
  const div = document.createElement("div");
  div.innerHTML = `
    <input value="${img}" placeholder="이미지 URL">
    <input value="${link}" placeholder="클릭 링크">
  `;
  imageAdmin.appendChild(div);
}

function removeImageAd() {
  if (imageAdmin.lastElementChild) {
    imageAdmin.removeChild(imageAdmin.lastElementChild);
  }
}

// 텍스트 광고 입력칸 추가
function addTextAd(title = "", link = "") {
  const div = document.createElement("div");
  div.innerHTML = `
    <input value="${title}" placeholder="텍스트">
    <input value="${link}" placeholder="클릭 링크">
  `;
  textAdmin.appendChild(div);
}

function removeTextAd() {
  if (textAdmin.lastElementChild) {
    textAdmin.removeChild(textAdmin.lastElementChild);
  }
}

// 이미지 광고 드래그 정렬
new Sortable(imageAdmin, {
  animation: 150,
  ghostClass: 'dragging'
});

// 텍스트 광고 드래그 정렬
new Sortable(textAdmin, {
  animation: 150,
  ghostClass: 'dragging'
});

</script>

</body>
</html>
